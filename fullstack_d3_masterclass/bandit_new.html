<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <link href="https://fonts.googleapis.com/css2?family=Roboto" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@700" rel="stylesheet">

    <style>
        #summary-chart {
            font-family: Roboto;
            font-size: 13px;
            background-color: #ffffff;
            width: inherit;
            height: inherit;
        }

        .key {
            color: #353135;
            background: #e0e0e0;
        }

        .value {
            color: #15607a;
            background: #ddebec;
            border-left: 2px solid #ffffff;
            width: 50%;
            min-width: 30px;
        }

        .key,
        .value {
            text-align: right;
            padding-right: 16px;
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .bold {
            font-weight: bold;
        }

        .border-bottom {
            border-bottom: 1px solid #ffffff;
        }

        .border-top-bottom {
            border-top: 1px solid #ffffff;
            border-bottom: 1px solid #ffffff;
        }

        .border-increased-size {
            border-top: 3px solid #ffffff;
            border-bottom: 3px solid #ffffff;
        }

        .border-top {
            border-top: 1px solid #ffffff;
        }

        .smaller-font {
            font-size: 90%;
        }

        .larger-font {
            font-size: 250%;
        }

        .regular-font {
            font-size: 100%;
        }

        svg {
            background-color: #333f4d;
        }

        .title-text {
            font-size: 50px;
            fill: white;
            font-family: Roboto;
        }

        .separator-line {
            stroke: white;
            stroke-width: 2px;
        }
    </style>

</head>

<body>
    <script src="https://d3js.org/d3.v4.min.js"></script>

    <script>

        // data
        let arms = 40320;
        let contexts = 12;
        let banditId = "vrbo_pdp_module_ranking_shopping_bandit";
        let campaignId = "1625157424572-18";
        let overallConvergence = 89.71;

        let isRanking = true;
        let detailedData = [
            {
                "category": "8", "convergence": 98.58, probabilities: [{ "option": "rooms_&_beds#virtual_tour", "probability": 84.95 },
                { "option": "amenities", "probability": 12.045 },
                { "option": "reviews", "probability": 3.005 }]
            },
            {
                "category": "4", "convergence": 93.72, probabilities: [{ "option": "rooms_&_beds#virtual_tour", "probability": 84.95 },
                { "option": "amenities", "probability": 12.045 },
                { "option": "reviews", "probability": 3.005 }]
            },
            {
                "category": "5", "convergence": 90.1, probabilities: [{ "option": "rooms_&_beds#virtual_tour", "probability": 84.95 },
                { "option": "amenities", "probability": 12.045 },
                { "option": "reviews", "probability": 3.005 }]
            },
            {
                "category": "6", "convergence": 99.9, probabilities: [{ "option": "rooms_&_beds#virtual_tour", "probability": 84.95 },
                { "option": "amenities", "probability": 12.045 },
                { "option": "reviews", "probability": 3.005 }]
            },
            {
                "category": "1", "convergence": 90.21, probabilities: [{ "option": "availability", "probability": 53.855 },
                { "option": "similar_properties#popular_destinations", "probability": 32.85 },
                { "option": "reviews", "probability": 10.78 }, { "option": "amenities", "probability": 2.395 },
                { "option": "host", "probability": 0.12 }]
            },
            {
                "category": "2", "convergence": 99.94, probabilities: [{ "option": "rooms_&_beds#virtual_tour", "probability": 84.95 },
                { "option": "amenities", "probability": 12.045 },
                { "option": "reviews", "probability": 3.005 }]
            },
            {
                "category": "7", "convergence": 99.91, probabilities: [{ "option": "rooms_&_beds#virtual_tour", "probability": 84.95 },
                { "option": "amenities", "probability": 12.045 },
                { "option": "reviews", "probability": 3.005 }]
            },
            {
                "category": "3", "convergence": 99.58, probabilities: [{ "option": "rooms_&_beds#virtual_tour", "probability": 84.95 },
                { "option": "amenities", "probability": 12.045 },
                { "option": "reviews", "probability": 3.005 }]
            }];


        let containerHeight = 1080, containerWidth = 1080,
            summaryTableHeight = 250, detailTableHeight = 720, padding = 25;

        let parent = d3.select("body")
            .append("svg")
            .attr("class", "parent-panel")
            .attr("width", containerWidth)
            .attr("height", containerHeight);

        // title panel rendering

        let titlePanelGroup = parent
            .append("g")
            .attr("id", "title")

        let titlePanelHeight = containerHeight / 10;

        titlePanelGroup.append("text")
            .text("BANDIT CAMPAIGN TRACKING")
            .attr("class", "title-text")
            .attr("x", containerWidth / 6)
            .attr("y", 2 * titlePanelHeight / 3);

        titlePanelGroup.append("line")
            .attr("class", "separator-line")
            .attr("x1", 0)
            .attr("x2", containerWidth)
            .attr("y1", titlePanelHeight)
            .attr("y2", titlePanelHeight);

        // summary table rendering    

        let summaryTable = parent
            .append("foreignObject")
            .attr("x", containerHeight / 4)
            .attr("y", titlePanelHeight + padding)
            .attr("width", containerWidth / 2)
            .attr("height", summaryTableHeight)
            .append("xhtml:table")
            .attr("id", "summary-chart")
            .attr("cellspacing", "0");

        let summaryBody = summaryTable.append("tbody");

        let firstRow = summaryBody.append("tr");
        firstRow.append("td")
            .attr("class", "smaller-font key border-bottom bold")
            .attr("colspan", "1")
            .text("campaign");

        firstRow.append("td")
            .attr("class", "smaller-font value border-bottom bold")
            .attr("colspan", "1")
            .text(campaignId);


        let secondRow = summaryBody.append("tr");
        secondRow.append("td")
            .attr("class", "smaller-font key border-top-bottom bold")
            .attr("colspan", "1")
            .text("bandit");

        secondRow.append("td")
            .attr("class", "smaller-font value border-top-bottom bold")
            .attr("colspan", "1")
            .text(banditId);

        let thirdRow = summaryBody.append("tr");
        thirdRow.append("td")
            .attr("class", "larger-font key border-increased-size bold")
            .attr("colspan", "1")
            .text("convergence");

        thirdRow.append("td")
            .attr("class", "larger-font value border-increased-size bold")
            .attr("colspan", "1")
            .text(overallConvergence);

        let fourthRow = summaryBody.append("tr");
        fourthRow.append("td")
            .attr("class", "regular-font key border-top-bottom")
            .attr("colspan", "1")
            .text("sampling from");

        fourthRow.append("td")
            .attr("class", "regular-font value border-top-bottom")
            .attr("colspan", "1")
            .html(`<b>${arms}</b> possible arms`);

        let fifthRow = summaryBody.append("tr");
        fifthRow.append("td")
            .attr("class", "regular-font key border-top")
            .attr("colspan", "1")
            .text("considering");

        fifthRow.append("td")
            .attr("class", "regular-font value border-top")
            .attr("colspan", "1")
            .html(`<b>${contexts}</b> different contexts`);

        parent.append("line")
            .attr("class", "separator-line")
            .attr("x1", 0)
            .attr("x2", containerWidth)
            .attr("y1", titlePanelHeight + summaryTableHeight + 2 * padding)
            .attr("y2", titlePanelHeight + summaryTableHeight + 2 * padding);

        // detailed table rendering

        let detailTable = parent
            .append("foreignObject")
            .attr("width", containerWidth - 2 * padding)
            .attr("height", detailTableHeight)
            .attr("x", padding)
            .attr("y", titlePanelHeight + summaryTableHeight + 3 * padding)
            .append("xhtml:table");

        let detailHead = detailTable.append("thead");
        let headerRow = detailHead.append("tr");
        headerRow.append("td")
            .text(isRanking ? "Rank" : "Category");
        headerRow.append("td")
            .text("Convergence");    
        
        let tr = detailTable
            .append("tbody")
            .selectAll("tr")
            .data(detailedData)
            .enter()
            .append("tr");

        
        let xScaleBarChart = d3.scaleLinear()
            .domain([0, 100]) // percentages
            .range([0, 100]); // 100 px

        let td = tr.selectAll("td.category")
            .data(function (d, i) { return [d.category]; })
            .enter()
            .append("td")
            .attr("class", "category-column")
            .text(function (d) { return d; });  
            
        let containerDiv = tr.selectAll("td.convergence")  
            .data(function (d, i) { return [d.convergence]; })
            .enter()
            .append("td")
            .attr("class", "convergence-column")
            .style("width", 100)
            .append("div") 
            .style("height", 17)

        containerDiv
            .append("div")
            .attr("width", "10%")
            .attr("height", 17)
            .transition()
            .duration(500)
            .style("width", function(d) { console.log(d); return d;})
            .style("background-color", "red")

            // .append("rect")
            // .attr("class", "bars")
            // .attr("x", xScaleBarChart(0))
            // .attr("y", function (d) { return 100; })
            // .attr("width", function (d) { return xScaleBarChart(d.convergence); })
            // .attr("height", "10")
            // .attr("fill", "#6ea4bf");


    </script>

    <table>
        <tbody>
            <tr>
                <td width=100>
                    <div width="100%" height="50"></div>

                </td>
            </tr>
        </tbody>

    </table>

</body>

</html>